#!/bin/bash

echo -e '\e[1m\e[33mBuilding the customized python-2.7.1 code...\e[0m'

function success() {
	echo -e '\e[1m\e[32mSuccessfully built python-2.7.1. Ready to build the plugin now.\e[0m'
	exit 0
}

function fail() {
	echo -e '\e[1m\e[34mAn error occured while building python-2.7.1. Cannot continue to build the plugin, please look at the above output to fix the error and try again.\e[0m'
	exit 1
}

dir=@CMAKE_CURRENT_SOURCE_DIR@/python-src
cd $dir
if test -f Makefile; then
	echo -e " ** python is already configured, will not configure again. To force reconfiguring, run: \n ** # rm python-src/Makefile"
else
	./configure --enable-shared || fail
fi
make || fail

if test -x /usr/bin/md5sum && test -f libpython2.7.so; then
	echo -ne "\n ** Checking weather an update of the library is necessary..."
	old=$(md5sum libpython2.7.so)
	p=$(pwd)
	cd "@BIN_INSTALL_DIR@"
	new=$(md5sum libpython2.7.so)
	cd $p
	if test "$old" != "$new"; then
		echo " yes"
		cp libpython2.7.so "@BIN_INSTALL_DIR@"/libpython2.7.so || fail
		test -f "@BIN_INSTALL_DIR@"/libpython2.7.so.1.0 || ln -s "@BIN_INSTALL_DIR@"/libpython2.7.so "@BIN_INSTALL_DIR@"/libpython2.7.so.1.0 || fail
	else
		echo " no"
	fi
fi

echo -e "\e[1m\e[32mSuccessfully installed file: @BIN_INSTALL_DIR@/libpython2.7.so\e[0m"

success

